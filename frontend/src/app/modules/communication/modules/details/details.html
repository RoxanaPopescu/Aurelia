<template>

    <require from="app/components/name-value-pair/name-value-pair"></require>
    <require from="app/components/name-value-list/name-value-list"></require>
    <require from="app/components/star-icon/star-icon"></require>
    <require from="app/components/numbered-section/numbered-section"></require>

    <require from="./components/order-pickup-completed-params/order-pickup-completed-params"></require>
    <require from="./components/order-delivery-arrived-params/order-delivery-arrived-params"></require>
    <require from="./components/order-delivery-completed-params/order-delivery-completed-params"></require>
    <require from="./components/order-delivery-failed-params/order-delivery-failed-params"></require>
    <require from="./components/order-delivery-eta-provided-params/order-delivery-eta-provided-params"></require>
    <require from="./components/order-delivery-delayed-eta-provided-params/order-delivery-delayed-eta-provided-params"></require>
    <require from="./components/order-pickup-eta-provided-params/order-pickup-eta-provided-params"></require>
    <require from="./components/order-schedule-triggered-params/order-schedule-triggered-params"></require>

    <require from="./details.scss"></require>

    <page name="details">

        <page-content class="${tab === 'geographic-areas' ? 'page-content-stretch' : ''}" scroll scroll.ref="scroll" validation validation.ref="validation">

            <page-header class="flex-row" scroll-fade>

                <h1 class="font-largest">
                    <path-nav>

                        <a accent="inherit" href="/communication/list" translate>
                            Communication
                        </a>

                        <div>

                            <template if.bind="model.id != null">
                                ${triggerName}
                                <star-icon entity.bind="model"></star-icon>
                            </template>

                            <template if.bind="model.id == null" translate>
                                New trigger
                            </template>

                        </div>

                    </path-nav>
                </h1>

                <div class="flex-push-right control-row">

                    <button appearance="solid" disabled.bind="loading || validation.invalid" accent="primary" click.trigger="onSaveClick()">

                        <template if.bind="model.id == null" translate>
                            Create trigger
                        </template>

                        <template if.bind="model.id != null" translate>
                            Save changes
                        </template>

                    </button>

                </div>

            </page-header>

            <name-value-list class="font-small opacity-faded">

                <name-value-pair if.bind="model.metadata.lastModified != null">

                    <div slot="name" translate>
                        Last modified
                    </div>

                    <div slot="value">
                        ${model.metadata.lastModified | dateTime: 'narrow'}
                        <span class="opacity-faded" translate>
                            by
                        </span>
                        ${model.metadata.lastModifiedBy}
                    </div>

                </name-value-pair>

                <name-value-pair if.bind="model.metadata.created != null">

                    <div slot="name" translate>
                        Created
                    </div>

                    <div slot="value">
                        ${model.metadata.created | dateTime: 'narrow'}
                        <span class="opacity-faded" translate>
                            by
                        </span>
                        ${model.metadata.createdBy}
                    </div>

                </name-value-pair>

            </name-value-list>

            <page-section>

                <div class="margin-larger-bottom" translate>
                    Here you can define a message to be sent when certain trigger conditions occur.
                </div>

                <numbered-section number.bind="1" heading.translate="Define trigger" class="--line-below">

                    <div class="control-row margin-large-bottom">

                        <text-input
                            label="above"
                            value.bind="model.name"
                            class="flex-basis-1-of-1">

                            <div slot="heading" translate>
                                Name of the trigger
                            </div>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.name">
                                </required-validator>

                            </div>

                        </text-input>

                    </div>

                    <div class="control-row margin-large-bottom">

                        <select-input
                            label="above"
                            none.bind="false"
                            value.bind="model.eventType"
                            display-value.bind="model.eventType.name"
                            change.trigger="setAvailableOptions($event.detail.value, model.recipientType)"
                            class="flex-basis-1-of-2">

                            <div slot="heading" translate>
                                Trigger event
                            </div>

                            <item repeat.for="eventType of availableTriggerEvents" model.bind="eventType">
                                ${eventType.name}
                            </item>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.eventType">
                                </required-validator>

                            </div>

                        </select-input>

                        <tags-input
                            label="above"
                            value.bind="model.shipmentCreatorIds"
                            class="flex-basis-1-of-2">

                            <div slot="heading" translate>
                                Applies to
                            </div>

                            <div slot="value">
                                <tag repeat.for="id of model.shipmentCreatorIds" model.bind="id">
                                    ${getCreatorFromId(id).primaryName}
                                </tag>
                            </div>

                            <item repeat.for="customer of availableCustomers" model.bind="customer.id">
                                ${customer.primaryName}
                            </item>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.shipmentCreatorIds.length > 0 ? true : undefined">
                                </required-validator>

                            </div>

                        </tags-input>

                    </div>

                    <div class="control-row margin-large-bottom">

                        <tags-input
                            label="above"
                            value.bind="model.routeTags"
                            new.bind="true"
                            class="flex-basis-1-of-1">

                            <div slot="heading" translate>
                                Applies to routes with the tags
                            </div>

                        </tags-input>

                    </div>

                    <div class="control-row margin-large-bottom">

                        <tags-input
                            label="above"
                            value.bind="model.stopTags"
                            new.bind="true"
                            class="flex-basis-1-of-1">

                            <div slot="heading" translate>
                                Applies to stops with the tags
                            </div>

                        </tags-input>

                    </div>

                    <div class="control-row">

                        <tags-input
                            label="above"
                            value.bind="model.orderTags"
                            new.bind="true"
                            class="flex-basis-1-of-1">

                            <div slot="heading" translate>
                                Applies to orders with the tags
                            </div>

                        </tags-input>

                    </div>

                </numbered-section>

                <numbered-section number.bind="2" heading.translate="Parameters" disabled.bind="model.eventType.slug == null" class="communication-parameters-section --line-below">

                    <div
                        if.bind="model.eventType.slug == null"
                        class="opacity-faded"
                        translate>
                        Please choose a trigger event
                    </div>

                    <order-pickup-completed-params
                        if.bind="model.eventType.slug === 'order-pickup-completed'"
                        model.bind="model.parameters">
                    </order-pickup-completed-params>

                    <order-delivery-arrived-params
                        if.bind="model.eventType.slug === 'order-delivery-arrived'"
                        model.bind="model.parameters">
                    </order-delivery-arrived-params>

                    <order-delivery-completed-params
                        if.bind="model.eventType.slug === 'order-delivery-completed'"
                        model.bind="model.parameters">
                    </order-delivery-completed-params>

                    <order-delivery-failed-params
                        if.bind="model.eventType.slug === 'order-delivery-failed'"
                        model.bind="model.parameters">
                    </order-delivery-failed-params>

                    <order-delivery-eta-provided-params
                        if.bind="model.eventType.slug === 'order-delivery-eta-provided'"
                        model.bind="model.parameters">
                    </order-delivery-eta-provided-params>

                    <order-delivery-delayed-eta-provided-params
                        if.bind="model.eventType.slug === 'order-delivery-delayed-eta-provided'"
                        model.bind="model.parameters">
                    </order-delivery-delayed-eta-provided-params>

                    <order-pickup-eta-provided-params
                        if.bind="model.eventType.slug === 'order-pickup-eta-provided'"
                        model.bind="model.parameters">
                    </order-pickup-eta-provided-params>

                    <order-schedule-triggered-params
                        if.bind="model.eventType.slug === 'order-schedule-triggered'"
                        model.bind="model.parameters">
                    </order-schedule-triggered-params>

                </numbered-section>

                <numbered-section number.bind="3" heading.translate="Choose recipient" disabled.bind="model.eventType.slug == null" class="--line-below">

                    <div class="control-row">

                        <select-input
                            label="above"
                            none.bind="false"
                            value.bind="model.recipientType"
                            display-value.bind="model.recipientType.name"
                            change.trigger="setAvailableOptions(model.eventType, $event.detail.value, model.messageType)"
                            class="flex-basis-1-of-2">

                            <div slot="heading" translate>
                                Send message to
                            </div>

                            <item repeat.for="recipient of options.recipientTypes" model.bind="recipient">
                                ${recipient.name}
                            </item>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.recipientType">
                                </required-validator>

                            </div>

                        </select-input>

                    </div>

                    <div if.bind="model.recipientType.slug === 'custom-email'" class="control-row  margin-large-top">

                        <email-input
                            label="above"
                            value.bind="model.to"
                            class="flex-basis-1-of-2">

                            <div slot="heading" translate>
                                Email address of the recipient
                            </div>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.to">
                                </required-validator>

                            </div>

                        </email-input>

                    </div>

                    <div if.bind="model.recipientType.slug === 'custom-phone'" class="control-row  margin-large-top">

                        <phone-input
                            label="above"
                            value.bind="model.to"
                            class="flex-basis-1-of-2">

                            <div slot="heading" translate>
                                Phone number of the recipient
                            </div>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.to">
                                </required-validator>

                            </div>

                        </phone-input>

                    </div>

                </numbered-section>

                <numbered-section number.bind="4" heading.translate="Choose message type" disabled.bind="model.recipientType.slug == null" class="--line-below">

                    <div class="control-row">

                        <select-input
                            label="above"
                            none.bind="false"
                            value.bind="model.messageType"
                            display-value.bind="model.messageType.name"
                            change.trigger="setAvailableOptions(model.eventType, model.recipientType, $event.detail.value)"
                            class="flex-basis-1-of-2">

                            <div slot="heading" translate>
                                Send message as
                            </div>

                            <item repeat.for="messageType of filteredMessageTypes" model.bind="messageType">
                                ${messageType.name}
                            </item>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.messageType">
                                </required-validator>

                            </div>

                        </select-input>

                    </div>

                </numbered-section>

                <numbered-section number.bind="5" heading.translate="Compose message" disabled.bind="model.recipientType.slug == null">

                    <div class="control-row margin-large-bottom">

                        <text-input
                            label="above"
                            value.bind="model.fromName"
                            class="flex-basis-1-of-1">

                            <div slot="heading" translate>
                                Name of the sender
                            </div>

                            <div slot="validation">

                                <length-validator
                                    if.bind="model.messageType.slug === 'sms'"
                                    value.bind="model.fromName"
                                    max.bind="11">
                                </length-validator>

                                <required-validator
                                    value.bind="model.fromName">
                                </required-validator>

                            </div>

                        </text-input>

                    </div>

                    <div if.bind="model.messageType.slug === 'email'" class="control-row margin-large-bottom">

                        <email-input
                            label="above"
                            value.bind="model.fromEmail"
                            class="flex-basis-1-of-1">

                            <div slot="heading" translate>
                                Email address of the sender
                            </div>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.fromEmail">
                                </required-validator>

                            </div>

                        </email-input>

                    </div>

                    <div if.bind="model.messageType.slug !== 'sms'" class="control-row margin-large-bottom">

                        <text-input
                            label="above"
                            value.bind="model.messageSubject"
                            class="flex-basis-1-of-1">

                            <div slot="heading" translate>
                                Message subject
                            </div>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.messageSubject">
                                </required-validator>

                            </div>

                        </text-input>

                    </div>

                    <div class="control-row">

                        <text-input
                            label="above"
                            trim.bind="false"
                            value.bind="model.messageContent"
                            class="flex-basis-1-of-1 --use-column-layout"
                            lines.bind="5"
                            ref="messageInputElement">

                            <div slot="heading">

                                <div translate>
                                    Message content
                                </div>

                                <select-button appearance="none" accent="primary">

                                    <div slot="label" class="flex-row">
                                        <span translate>
                                            Insert placeholder
                                        </span>
                                    </div>

                                    <item
                                        repeat.for="placeholder of options.placeholders"
                                        model.bind="placeholder.placeholder"
                                        click.trigger="onMessagePlaceholderClick(placeholder.placeholder)">

                                        <div accent="primary">
                                            ${placeholder.placeholder}
                                        </div>

                                        <div class="font-small margin-smallest-top opacity-faded" translate>
                                            ${placeholder.description}
                                        </div>

                                    </item>

                                </select-button>

                            </div>

                            </div>

                            <div slot="validation">

                                <required-validator
                                    value.bind="model.messageContent">
                                </required-validator>

                            </div>

                        </text-input>

                    </div>

                </numbered-section>

            </page-section>

        </page-content>

    </page>

</template>
