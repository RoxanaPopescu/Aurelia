<template>

    <require from="app/components/page-tab-nav/page-tab-nav"></require>
    <require from="app/components/page-tab-nav/page-tab"></require>
    <require from="./start-locations.scss"></require>

    <page-section if.bind="hasDeletedVehicleGroups(undefined, bindingUpdateTrigger)">

        <div class="font-small">
            <invalid-validator active.bind="true">

                <template replace-part="invalid" translate>
                    One or more reservations reference vehicle groups that have been deleted.<br>
                    Please ensure a vehicle group is chosen for each reservation, at each start location.
                </template>

            </invalid-validator>
        </div>

    </page-section>

    <page-section class="no-start-locations" if.bind="settings.departureTimes.length === 0">

        <empty-indicator class="margin-largest-top">

            <span slot="heading" translate>
                No start locations specified
            </span>

            <div slot="details">

                <button
                    appearance="outline"
                    class="flex-row"
                    accent="primary"
                    click.delegate="onAddDepartureTimeClick()">

                    <icon name="plus-small" class="margin-right"></icon>

                    <span translate>
                        New start location
                    </span>

                </button>

                <div class="font-small margin-large-top"></div>

            </div>

        </empty-indicator>

    </page-section>

    <template if.bind="settings.departureTimes.length > 0">

        <page-tab-nav appearance="tabs" value.bind="activeDepartureTimeName">

            <page-tab repeat.for="departureTime of settings.departureTimes" model.bind="departureTime.name" invalid.bind="(bindingUpdateTrigger && undefined) || hasDeletedVehicleGroups(departureTime, bindingUpdateTrigger)">

                <span class="text-truncate" title.bind="departureTime.name">
                    ${departureTime.name}
                </span>

                <div class="page-tab-buttons">

                    <button
                        appearance="none"
                        accent="primary"
                        disabled.bind="departureTime.name !== activeDepartureTimeName"
                        title.translate="Edit start location"
                        click.delegate="onEditDepartureTimeClick(departureTime)">
                        <icon name="edit-small" inline></icon>
                    </button>

                    <button
                        appearance="none"
                        accent="primary"
                        disabled.bind="departureTime.name !== activeDepartureTimeName"
                        title.translate="Delete start location"
                        click.delegate="onDeleteDepartureTimeClick(departureTime)">
                        <icon name="delete-small" inline></icon>
                    </button>

                </div>

            </page-tab>

            <button
                appearance="none"
                class="page-tab-nav-add-button"
                click.delegate="onAddDepartureTimeClick()">

                <icon name="plus-small" inline class="margin-right"></icon>

                <span translate>
                    New start location
                </span>

            </button>

        </page-tab-nav>

        <page-section>

            <div class="flex-basis-1-of-2">

                <div class="font-largest departure-time-name">
                    ${activeDepartureTime.name}
                </div>

                <h4 class="margin-top">
                    ${activeDepartureTime.startLocation.address.toString()}
                </h4>

            </div>

        </page-section>

        <page-section class="--line-above" if.bind="activeDepartureTime.scenarios.length == 0">

            <empty-indicator size="medium" class="margin-larger-top">

                <span slot="heading" translate>
                    No reservations specified
                </span>

                <div slot="details">
                    <button
                        appearance="outline"
                        class="add-reservation-button flex-row"
                        accent="primary"
                        click.delegate="onAddScenarioClick()">

                        <icon name="plus-small" inline class="margin-right"></icon>

                        <span translate>
                            New reservation
                        </span>

                    </button>
                </div>

            </empty-indicator>

        </page-section>

        <template if.bind="activeDepartureTime.scenarios.length != 0">

            <page-section class="scenarios-container --line-above">

                <div class="control-row">

                    <div class="flex-basis-1-of-2">

                        <div class="font-larger" translate>
                            Reservation times for gates
                        </div>

                        <h4 class="margin-medium-top" translate>
                            Here you can specify reservation times for gates.
                        </h4>

                    </div>

                    <div class="flex-basis-1-of-2">

                        <button
                            appearance="outline"
                            class="add-reservation-button flex-push-right"
                            accent="primary"
                            click.delegate="onAddScenarioClick()">

                            <icon name="plus-small" inline class="margin-right"></icon>

                            <span translate>
                                New reservation
                            </span>

                        </button>

                    </div>

                </div>

                <div class="scenarios-filters margin-larger-top">

                    <date-input
                        label="above"
                        value.bind="dateFromFilter"
                        max.bind="dateToFilter">

                        <div slot="heading" translate>
                            From date
                        </div>

                        <div slot="validation">

                            <range-validator
                                active.bind="true"
                                value.bind="dateFromFilter"
                                max.bind="dateToFilter">

                                <template replace-part="invalid-max" translate>
                                    Please choose a time before the to time.
                                </template>

                            </range-validator>

                        </div>

                    </date-input>

                    <date-input
                        class="margin-larger-left"
                        label="above"
                        value.bind="dateToFilter"
                        min.bind="dateFromFilter">

                        <div slot="heading" translate>
                            To date
                        </div>

                        <div slot="validation">

                            <range-validator
                                active.bind="true"
                                value.bind="dateToFilter"
                                min.bind="dateFromFilter">

                                <template replace-part="invalid-min" translate>
                                    Please choose a time after the from time.
                                </template>

                            </range-validator>

                        </div>

                    </date-input>

                    </date-input>

                    <tags-input
                        class="margin-larger-left"
                        label="above"
                        value.bind="weekdaysFilter"
                        filter="auto">

                        <div slot="heading" translate>
                            Weekdays
                        </div>

                        <div slot="value">
                            <tag repeat.for="weekday of weekdaysFilter" model.bind="weekday">
                                ${weekday | weekday}
                            </tag>
                        </div>

                        <item repeat.for="weekday of 7" model.bind="weekday + 1">
                            ${weekday + 1 | weekday}
                        </item>

                    </tags-input>

                </div>

            </page-section>

            <page-section class="--line-above">

                <data-table appearance="rows" sorting.bind="sorting">

                    <data-table-headers>

                        <data-table-cell name="name">
                            <span class="text-truncate" translate>
                                Name
                            </span>
                        </data-table-cell>

                        <data-table-cell name="gate">
                            <span class="text-truncate" translate>
                                Gate
                            </span>
                        </data-table-cell>

                        <data-table-cell name="weekdays">
                            <span class="text-truncate" translate>
                                Reserved weekdays
                            </span>
                        </data-table-cell>

                        <data-table-cell name="from-date">
                            <span class="text-truncate" translate>
                                From date
                            </span>
                        </data-table-cell>

                        <data-table-cell name="to-date">
                            <span class="text-truncate" translate>
                                To date
                            </span>
                        </data-table-cell>

                        <data-table-cell name="vehicle-group">
                            <span class="text-truncate" translate>
                                Vehicle group
                            </span>
                        </data-table-cell>

                        <data-table-cell align="right">
                            &nbsp;
                        </data-table-cell>

                    </data-table-headers>

                    <template repeat.for="scenario of orderedAndFilteredScenarios">

                        <data-table-row click.call="onScenarioClick(scenario)">

                            <data-table-cell>
                                <span class="text-truncate">
                                    ${scenario.name}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate">
                                    ${scenario.gates[0].name}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate">
                                    ${scenario.criteria.weekdays | weekdayList}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate">
                                    ${scenario.criteria.datePeriod.from | date: 'narrow' : false}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate">
                                    ${scenario.criteria.datePeriod.to | date: 'narrow' : false}
                                </span>
                            </data-table-cell>

                            <data-table-cell>

                                <let
                                    vehicle-group.bind="getVehicleGroup(scenario.gates[0].slots[0].vehicleGroup, bindingUpdateTrigger)">
                                </let>

                                <span if.bind="vehicleGroup != null" class="text-truncate">
                                    ${vehicleGroup.name}
                                </span>

                                <span else empty-value accent="negative"></span>

                            </data-table-cell>

                            <data-table-cell align="right">

                                <div class="icon-row">

                                    <button if-claims="edit-routeplan-settings" appearance="none" accent="primary" click.trigger="onDeleteScenarioClick(scenario)">
                                        <icon name="delete-small"></icon>
                                    </button>

                                </div>

                            </data-table-cell>

                        </data-table-row>

                    </template>

                </data-table>

            </page-section>

        </template>

    </template>

</template>
