<template>

    <require from="app/components/info-icon/info-icon"></require>
    <require from="app/components/address-input/address-input"></require>

    <require from="./route-filters.scss"></require>

    <modal-backdrop close="all"></modal-backdrop>

    <modal-panel name="route-filters" position="right" close-button.bind="true" close-shortcut.bind="true" scroll>

        <!--
        <div slot="actions">

            <button
                if.bind="view === 'active-filters' && model.filter.activeCriteria.length > 0"
                appearance="icon"
                title.translate="Reset"
                click.trigger="onResetClick()">
                <icon name="ico-restart"></icon>
            </button>

        </div>
        -->

        <!-- Filters view -->
        <div class="route-filters-active-filters-view" if="condition.bind: view === 'active-filters'; cache: false">

            <modal-header scroll-fade>

                <h1 class="font-largest margin-bottom">

                    <path-nav>

                        <div translate>
                            Filters
                        </div>

                    </path-nav>

                </h1>

                <h2 class="font-large">

                    <template if.bind="model.filter.activeCriteria.length > 0" translate>
                        The following filters are currently applied
                    </template>

                    <template else translate>
                        No filters are currently applied
                    </template>

                </h2>

            </modal-header>

            <modal-section>

                <data-table
                    appearance="rows"
                    insert.call="onAddFilterClick()"
                    insert-mode="insert">

                    <data-table-row repeat.for="criterion of model.filter.activeCriteria" click.call="onChooseFilter(criterion)">

                        <data-table-cell>
                            ${criterion.name}
                        </data-table-cell>

                        <data-table-cell>
                            <tags-input readonly.bind="true" class="--tags-only">
                                <div slot="value">
                                    <tag repeat.for="part of criterion.summary">
                                        ${part}
                                    </tag>
                                </div>
                            </tags-input>
                        </data-table-cell>

                        <data-table-cell align="right">

                            <div class="icon-row">

                                <button
                                    title.translate="Remove filter"
                                    appearance="none"
                                    accent="primary"
                                    click.trigger="onRemoveFilterClick(criterion)">

                                    <icon name="ico-delete-small"></icon>

                                </button>

                            </div>

                        </data-table-cell>

                    </data-table-row>

                    <template replace-part="insert" translate>
                        Add filter
                    </template>

                </data-table>

            </modal-section>

        </div>

        <!-- Add filter view -->
        <div class="route-filters-add-filter-view" if="condition.bind: view === 'add-filter'; cache: false">

            <modal-header scroll-fade>

                <h1 class="font-largest margin-bottom">

                    <path-nav>

                        <a accent="inherit" click.trigger="onBackToActiveFiltersClick()" tabindex="0" translate>
                            Filters
                        </a>

                        <div translate>
                            Add
                        </div>

                    </path-nav>

                </h1>

                <h2 class="font-large margin-larger-bottom" translate>
                    Choose the filter you want to apply
                </h2>

                <search-input value.bind="queryText" autofocus>

                    <span slot="before">
                        <icon name="ico-search" class="font-larger opacity-faded"></icon>
                    </span>

                    <span slot="placeholder" translate>
                        Find filterâ€¦
                    </span>

                </search-input>

            </modal-header>

            <modal-section>

                <data-table if.bind="filteredCriteria.length > 0" appearance="rows">

                    <data-table-row
                        repeat.for="criterion of filteredCriteria"
                        faded.to-view="criterion.summary != null"
                        click.call="onChooseFilter(criterion)">

                        <data-table-cell>
                            ${criterion.name}
                        </data-table-cell>

                        <data-table-cell>
                            <span if.bind="criterion.summary != null" class="text-truncate" translate>
                                Applied
                            </span>
                        </data-table-cell>

                    </data-table-row>

                </data-table>

                <no-results-indicator else class="margin-larger" translate>
                    No results
                </no-results-indicator>

            </modal-section>

        </div>

        <!-- Edit filter view -->
        <div class="route-filters-edit-filter-view" if="condition.bind: view === 'edit-filter'; cache: false">

            <modal-header scroll-fade>

                <h1 class="font-largest margin-bottom">

                    <path-nav>

                        <a accent="inherit" click.trigger="onBackToActiveFiltersClick()" tabindex="0" translate>
                            Filters
                        </a>

                        <a if.bind="previousView === 'add-filter'" accent="inherit" click.trigger="onBackToAddFilterClick()" translate>
                            Add
                        </a>

                        <div translate>
                            ${criterion.name}
                        </div>

                    </path-nav>

                </h1>

                <h2 class="font-large" translate>
                    ${criterion.description}
                </h2>

            </modal-header>

            <modal-section>

                <!-- Status filter -->
                <template if.bind="criterion.slug === 'status'">

                    <toggle-group class="flex-column" value.bind="criterion.model.statusFilter">

                        <check-toggle label="after" model="not-started">

                            <div slot="heading" translate>
                                Not started
                            </div>

                        </check-toggle>

                        <check-toggle label="after" model="in-progress">

                            <div slot="heading" translate>
                                In progress
                            </div>

                        </check-toggle>

                        <check-toggle label="after" model="not-approved">

                            <div slot="heading" translate>
                                Not approved
                            </div>

                        </check-toggle>

                        <check-toggle label="after" model="to-be-express-dispatched">

                            <div slot="heading" translate>
                                To be express dispatched
                            </div>

                        </check-toggle>

                        <check-toggle label="after" model="cancelled">

                            <div slot="heading" translate>
                                Cancelled
                            </div>

                        </check-toggle>

                        <check-toggle label="after" model="completed">

                            <div slot="heading" translate>
                                Completed
                            </div>

                        </check-toggle>

                    </toggle-group>

                </template>

                <!-- Start time filter -->
                <template if.bind="criterion.slug === 'start-time'">

                    <div class="flex-row margin-larger-bottom">

                        <div class="flex-basis-1-of-2">

                            <date-input if.bind="!criterion.model.useRelativeStartTimeFromFilter" label="above" fixed.bind="true" value.bind="criterion.model.startTimeFromFilter">

                                <div slot="heading" translate>
                                    From
                                </div>

                            </date-input>

                            <duration-input else label="above" fixed.bind="true" unit.bind="criterion.model.relativeStartTimeFromFilterUnit" value.bind="criterion.model.relativeStartTimeFromFilter">

                                <div slot="heading" translate>
                                    From
                                </div>

                                <select-input none.bind="false" slot="after" value.bind="criterion.model.relativeStartTimeFromFilterUnit"
                                    style="width: 160rem;">

                                    <item model="hours" translate>
                                        hours
                                    </item>

                                    <item model="days" translate>
                                        days
                                    </item>

                                </select-input>

                            </duration-input>

                        </div>

                        <div class="flex-basis-1-of-2 margin-large-left" style="align-self: flex-end; margin-bottom: calc((40rem - 28rem) / 2);">

                            <check-toggle label="after" value.bind="criterion.model.useRelativeStartTimeFromFilter">

                                <div slot="heading">
                                    <template if.bind="criterion.model.useRelativeStartTimeFromFilter && criterion.model.relativeStartTimeFromFilterUnit === 'days'" translate>
                                        Relative to today
                                    </template>
                                    <template if.bind="criterion.model.useRelativeStartTimeFromFilter && criterion.model.relativeStartTimeFromFilterUnit === 'hours'" translate>
                                        Relative to now
                                    </template>
                                    <template if.bind="!criterion.model.useRelativeStartTimeFromFilter || criterion.model.relativeStartTimeFromFilterUnit === null" translate>
                                        Relative
                                    </template>
                                </div>

                            </check-toggle>

                        </div>

                    </div>

                    <div class="flex-row">

                        <div class="flex-basis-1-of-2">

                            <date-input if.bind="!criterion.model.useRelativeStartTimeToFilter" label="above" fixed.bind="true" value.bind="criterion.model.startTimeToFilter">

                                <div slot="heading" translate>
                                    To
                                </div>

                            </date-input>

                            <duration-input else label="above" fixed.bind="true" unit.bind="criterion.model.relativeStartTimeToFilterUnit" value.bind="criterion.model.relativeStartTimeToFilter">

                                <div slot="heading" translate>
                                    To
                                </div>

                                <select-input none.bind="false" slot="after" value.bind="criterion.model.relativeStartTimeToFilterUnit"
                                    style="width: 160rem;">

                                    <item model="hours" translate>
                                        hours
                                    </item>

                                    <item model="days" translate>
                                        days
                                    </item>

                                </select-input>

                            </duration-input>

                        </div>

                        <div class="flex-basis-1-of-2 margin-large-left" style="align-self: flex-end; margin-bottom: calc((40rem - 28rem) / 2);">

                            <check-toggle label="after" value.bind="criterion.model.useRelativeStartTimeToFilter">

                                <div slot="heading">
                                    <template if.bind="criterion.model.useRelativeStartTimeToFilter && criterion.model.relativeStartTimeToFilterUnit === 'days'" translate>
                                        Relative to today
                                    </template>
                                    <template if.bind="criterion.model.useRelativeStartTimeToFilter && criterion.model.relativeStartTimeToFilterUnit === 'hours'" translate>
                                        Relative to now
                                    </template>
                                    <template if.bind="!criterion.model.useRelativeStartTimeToFilter || criterion.model.relativeStartTimeToFilterUnit === null" translate>
                                        Relative
                                    </template>
                                </div>

                            </check-toggle>

                        </div>

                    </div>

                </template>

                <!-- Assignment filter -->
                <template if.bind="criterion.slug === 'assignment'">

                    <check-toggle label="after" value.bind="criterion.model.assignedDriver">

                        <div slot="heading" translate>
                            Driver assigned
                        </div>

                    </check-toggle>

                    <check-toggle label="after" value.bind="criterion.model.notAssignedDriver">

                        <div slot="heading" translate>
                            No driver assigned
                        </div>

                    </check-toggle>

                    <check-toggle label="after" value.bind="criterion.model.assignedVehicle">

                        <div slot="heading" translate>
                            Vehicle assigned
                        </div>

                    </check-toggle>

                    <check-toggle label="after" value.bind="criterion.model.notAssignedVehicle">

                        <div slot="heading" translate>
                            No vehicle assigned
                        </div>

                    </check-toggle>

                </template>

                <!-- Ordered vehicle type filter -->
                <template if.bind="criterion.slug === 'ordered-vehicle-type'">

                    <toggle-group class="flex-column" value.bind="criterion.model.orderedVehicleTypesFilter">

                        <check-toggle repeat.for="vehicleType of availableVehicleTypes" model.bind="vehicleType" label="after">

                            <div slot="heading" translate>
                                ${vehicleType.name}
                            </div>

                        </check-toggle>

                    </toggle-group>

                </template>

                <!-- Teams filter -->
                <template if.bind="criterion.slug === 'teams'">

                    <tags-input label="above" filter="auto" value.bind="criterion.model.teamsFilter">

                        <div slot="value">
                            <tag repeat.for="teamId of criterion.model.teamsFilter" model.bind="teamId">
                                <template if.bind="teamId === 'no-team'" translate>
                                    No team
                                </template>
                                <template else>
                                    ${getTeamName(teamId)}
                                </template>
                            </tag>
                        </div>

                        <item repeat.for="team of teams" model.bind="team.id">
                            <template if.bind="team.id === 'no-team'" translate>
                                No team
                            </template>
                            <template else>
                                ${team.name}
                            </template>
                        </item>

                    </tags-input>

                </template>

                <!-- Tags filter -->
                <template if.bind="criterion.slug === 'tags'">

                    <tags-input label="above" value.bind="criterion.model.tagsFilter" new.bind="true"></tags-input>

                </template>

                <!-- Pickup nearby filter -->
                <template if.bind="criterion.slug === 'pickup-nearby'">

                    <address-input label="above" value.bind="criterion.model.pickupNearbyAddress"></address-input>

                </template>

                <!-- Owner IDs filter -->
                <template if.bind="criterion.slug === 'legacy-owner-ids'">

                    <tags-input label="above" value.bind="criterion.model.legacyOwnerIdsFilter" new.bind="true"></tags-input>

                </template>

                <!-- Created time filter -->
                <template if.bind="criterion.slug === 'created-time'">

                    <div class="flex-row margin-larger-bottom">

                        <div class="flex-basis-1-of-2">

                            <date-input label="above" fixed.bind="true" value.bind="criterion.model.createdTimeFromFilter">

                                <div slot="heading" translate>
                                    From
                                </div>

                            </date-input>

                        </div>

                    </div>

                    <div class="flex-row">

                        <div class="flex-basis-1-of-2">

                            <date-input label="above" fixed.bind="true" value.bind="criterion.model.createdTimeToFilter">

                                <div slot="heading" translate>
                                    To
                                </div>

                            </date-input>

                        </div>

                    </div>

                </template>

                <button appearance="solid" accent="primary" class="margin-larger-top" click.trigger="onApplyFilterClick()" translate>
                    Apply
                </button>

            </modal-section>

        </div>

    </modal-panel>

</template>
