<template>

    <require from="app/components/name-value-pair/name-value-pair"></require>
    <require from="app/components/star-icon/star-icon"></require>
    <require from="./components/route-overview/route-overview"></require>
    <require from="./components/route-map/route-map"></require>
    <require from="./details.scss"></require>

    <page name="details">

        <page-sidebar name="routes-details-page-sidebar" scroll>

            <page-section toggle.bind="true">

                <div slot="header" translate>
                    Route info
                </div>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        ID
                    </div>

                    <div slot="value" empty-value>
                        <template if.bind="route">
                            ${route.slug}
                        </template>
                        <template if.bind="!route">
                            ${routeSlug}
                        </template>
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Type
                    </div>

                    <div slot="value" empty-value>
                        ${route.productType.name}
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Owner
                    </div>

                    <div slot="value" empty-value>
                        ${route.owner.primaryName}
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Reference
                    </div>

                    <div slot="value" empty-value>
                        ${route.reference}
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Status
                    </div>

                    <div slot="value" accent.bind="route.status.slug === 'cancelled' ? 'negative' : 'neutral' & attr" empty-value>
                        ${route.status.name}
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Vehicle
                    </div>

                    <div slot="value" empty-value>
                        ${route.vehicleType.name}
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Total volume of all pickups
                    </div>

                    <div slot="value" empty-value>
                        <template if.bind="route.totalVolume != null">
                            ${route.totalVolume | number: 0 : 3} mÂ³
                        </template>
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Total weight of all pickups
                    </div>

                    <div slot="value" empty-value>
                        <template if.bind="route.totalWeight != null">
                            ${route.totalWeight | number: 0} kg
                        </template>
                    </div>

                </name-value-pair>

                <name-value-pair if.bind="route.totalWeightRange" class="margin-bottom">

                    <div slot="name" translate>
                        Weight range
                    </div>

                    <div slot="value" empty-value>
                        <template if.bind="route.totalWeightRange != null">
                            ${route.totalWeightRange.from | number: 0} - ${route.totalWeightRange.to | number: 0} kg
                        </template>
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Colli count
                    </div>

                    <div slot="value" empty-value>
                        ${route.totalColliCount | number}
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Complexity
                    </div>

                    <div slot="value" empty-value>
                        <template if.bind="route.complexity != null">
                            ${route.complexity | number}%
                        </template>
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Criticality
                    </div>

                    <div slot="value" empty-value>
                        ${route.criticality.name}
                    </div>

                </name-value-pair>

                <name-value-pair>

                    <div slot="name" translate>
                        Distance
                    </div>

                    <div slot="value" empty-value>

                        <template if.bind="route.initialEstimates.distance">
                            ${route.initialEstimates.distance/1000 | number : undefined : 1 } km
                        </template>

                        <template if.bind="!route.initialEstimates.distance && route.distance">
                            ${route.distance/1000 | number : undefined : 1 } km
                        </template>

                    </div>

                </name-value-pair>

            </page-section>

            <page-section
                if.bind="environment == 'development' || route.isPrimaryFulfiller"
                toggle.bind="true"
                expanded.to-view="route.supportNote">

                <div slot="header" translate>
                    Support note
                </div>

                <name-value-pair>

                    <div slot="value" class="text-align-left white-space-pre-line" empty-value>${route.supportNote}</div>

                </name-value-pair>
            </page-section>

            <page-section toggle.bind="true">

                <div slot="header" translate>
                    Time frame
                </div>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Starts
                    </div>

                    <div slot="value" empty-value>
                        ${route.plannedTimeFrame.from | dateTime: 'narrow' : false}
                    </div>

                </name-value-pair>

                <name-value-pair>

                    <div slot="name" translate>
                        Ends
                    </div>

                    <div slot="value" empty-value>
                        ${route.plannedTimeFrame.to | dateTime: 'narrow' : false}
                    </div>

                </name-value-pair>

            </page-section>

            <page-section toggle.bind="true">

                <div slot="header" translate>
                    First pickup
                </div>

                <name-value-pair>

                    <div slot="name" translate>
                        Address
                    </div>

                    <div slot="value" empty-value>
                        <span
                            if.bind="route.stops[0].location.address"
                            innerhtml.bind="route.stops[0].location.address.toHtmlString()">
                        </span>
                    </div>

                </name-value-pair>

            </page-section>

            <page-section toggle.bind="true">

                <div slot="header" translate>
                    Executor
                </div>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Company
                    </div>

                    <div slot="value" empty-value>
                        ${route.executor.primaryName}
                    </div>

                </name-value-pair>

            </page-section>

            <page-section toggle.bind="true" expanded.to-view="route.driver">

                <div slot="header" translate>
                    Driver
                </div>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Driver Id
                    </div>

                    <a target="_blank" href="/fleet-management/drivers/details/${route.driver.id}" if.bind="route.driver" slot="value">
                        ${route.driver.id}
                    </a>

                    <div if.bind="!route.driver" slot="value" empty-value></div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Driver name
                    </div>

                    <div slot="value" empty-value>
                        ${route.driver.name}
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Driver phone
                    </div>

                    <div slot="value" empty-value>
                        ${route.driver.phone}
                    </div>

                </name-value-pair>

                <name-value-pair>

                    <div slot="name" translate>
                        Driver system
                    </div>

                    <div slot="value" empty-value>
                        <template if.bind="route.driver != null">
                            ${route.driver.device.os} (${route.driver.device.appVersion})
                        </template>
                    </div>

                </name-value-pair>

            </page-section>

            <page-section toggle.bind="true" expanded.to-view="false">

                <div slot="header" translate>
                    Vehicle
                </div>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Type
                    </div>

                    <div slot="value" empty-value>
                        ${route.vehicle.type.name}
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Make and model
                    </div>

                    <div slot="value" empty-value>
                        ${route.vehicle.makeAndModel}
                    </div>

                </name-value-pair>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Color
                    </div>

                    <div slot="value" empty-value>
                        ${route.vehicle.color}
                    </div>

                </name-value-pair>

                <name-value-pair>

                    <div slot="name" translate>
                        License plate
                    </div>

                    <div slot="value" empty-value>
                        ${route.vehicle.licensePlate}
                    </div>

                </name-value-pair>

            </page-section>

            <page-section toggle.bind="true" expanded.to-view="false">

                <div slot="header" translate>
                    Instructions
                </div>

                <name-value-pair>

                    <div slot="value" class="text-align-left white-space-pre-line" empty-value>${route.driverInstructions}</div>

                </name-value-pair>

            </page-section>

            <page-section toggle.bind="true" expanded.to-view="false">

                <div slot="header" translate>
                    Tags
                </div>

                <div if.bind="route == null || route.tags.length == 0" empty-value></div>

                <tags-input if.bind="route.tags.length > 0" readonly.bind="true" class="--tags-only">

                    <div slot="value">
                        <tag repeat.for="tag of route.tags">
                            ${tag}
                        </tag>
                    </div>

                </tags-input>

            </page-section>

            <page-section toggle.bind="true" expanded.to-view="false">

                <div slot="header" translate>
                    Price
                </div>

                <let p.bind="route.priceOverview"></let>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Route price
                    </div>

                    <div slot="value" empty-value>
                        ${p && { amount: p.price, currencyCode: p.currencyCode } | currency }
                    </div>

                </name-value-pair>

                <name-value-pair>

                    <div slot="name" translate>
                        VAT
                    </div>

                    <div slot="value" empty-value>
                        ${p && { amount: p.vat, currencyCode: p.currencyCode } | currency }
                    </div>

                </name-value-pair>

                <hr class="hr-line margin">

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Total price
                    </div>

                    <div slot="value" empty-value>
                        ${p && { amount: p.totalPrice, currencyCode: p.currencyCode } | currency }
                    </div>

                </name-value-pair>

            </page-section>

            <page-section toggle.bind="true" expanded.to-view="false">

                <div slot="header" translate>
                    Other
                </div>

                <name-value-pair class="margin-bottom">

                    <div slot="name" translate>
                        Legacy id
                    </div>

                    <a target="_blank" href="https://admin.mover.dk/dk/da/user-area/trips/session/${route.legacyId}" if.bind="route.driver" slot="value" empty-value>
                        ${route.legacyId}
                    </a>

                    <a target="_blank" href="https://admin.mover.dk/dk/da/user-area/trips/request/${route.legacyId}" if.bind="!route.driver" slot="value" empty-value>
                        ${route.legacyId}
                    </a>

                </name-value-pair>

            </page-section>

        </page-sidebar>

        <page-content scroll scroll.ref="scroll">

            <page-header scroll-fade class="flex-row">

                <h1 class="font-largest">
                    <path-nav>

                        <a accent="inherit" href="/routes" translate>
                            Routes
                        </a>

                        <span class="user-select-text">
                            <template if.bind="route">
                                ${route.slug}
                            </template>
                            <template if.bind="!route">
                                ${routeSlug}
                            </template>
                            <star-icon entity.bind="route"></star-icon>
                        </span>
                    </path-nav>
                </h1>

                <toolbar if.bind="route" class="flex-push-right">

                    <select-button appearance="outline" accent="primary">

                        <div slot="label" translate>
                            Assign
                        </div>

                        <item
                            if-claims="assign-organization-route"
                            model="assign-executor"
                            click.trigger="onAssignExecutorClick()">
                            <template if.bind="route.executor.id == identityService.identity.organization.id" translate>
                                Assign executor
                            </template>
                            <template if.bind="route.executor.id != identityService.identity.organization.id" translate>
                                Reassign executor
                            </template>
                        </item>

                        <item
                            if-claims="assign-driver-route"
                            model="assign-driver"
                            click.trigger="onAssignDriverClick()">
                            <template if.bind="!route.driver" translate>
                                Assign driver
                            </template>
                            <template if.bind="route.driver" translate>
                                Reassign driver
                            </template>
                        </item>

                        <item
                            if-claims="assign-vehicle-route"
                            model="assign-vehicle"
                            click.trigger="onAssignVehicleClick()">
                            <template if.bind="!route.vehicle" translate>
                                Assign vehicle
                            </template>
                            <template if.bind="route.vehicle" translate>
                                Reassign vehicle
                            </template>
                        </item>

                        <item
                            if-claims="edit-routes"
                            model="assign-team"
                            click.trigger="onAssignTeamClick()">
                            <template if.bind="!route.teamId" translate>
                                Assign team
                            </template>
                            <template if.bind="route.teamId" translate>
                                Reassign team
                            </template>
                        </item>

                    </select-button>

                    <select-button if-claims="edit-routes" appearance="outline" accent="primary">

                        <div slot="label" translate>
                            Change status
                        </div>

                        <item
                            model="not-started"
                            disabled.bind="['not-started'].includes(route.status.slug)"
                            click.trigger="onStatusItemClick('not-started')"
                            translate>
                            Not started
                        </item>

                        <item
                            model="not-approved"
                            disabled.bind="['not-approved', 'in-progress', 'completed', 'cancelled'].includes(route.status.slug)"
                            click.trigger="onStatusItemClick('not-approved')"
                            translate>
                            Not approved
                        </item>

                        <item
                            model="to-be-express-dispatched"
                            if.bind="showLegacy"
                            disabled.bind="['to-be-express-dispatched'].includes(route.status.slug)"
                            click.trigger="onStatusItemClick('to-be-express-dispatched')"
                            translate>
                            To be express dispatched
                        </item>

                        <item
                            model="in-progress"
                            disabled.bind="['in-progress', 'not-approved'].includes(route.status.slug)"
                            click.trigger="onStatusItemClick('in-progress')"
                            translate>
                            In progress
                        </item>

                        <item
                            model="completed"
                            disabled.bind="['completed', 'not-approved'].includes(route.status.slug)"
                            click.trigger="onStatusItemClick('completed')"
                            translate>
                            Completed
                        </item>

                        <item
                            model="cancelled"
                            disabled.bind="['cancelled'].includes(route.status.slug)"
                            click.trigger="onStatusItemClick('cancelled')"
                            translate>
                            Cancelled
                        </item>

                    </select-button>

                    <select-button appearance="outline" accent="primary" placement="bottom-end">

                        <div slot="icon">
                            <icon name="ico-more"></icon>
                        </div>

                        <template if-claims="edit-routes">

                            <item
                                if.bind="route"
                                model="edit-route"
                                click.trigger="onEditRouteClick()"
                                translate>
                                Edit route
                            </item>

                        </template>

                        <item
                            model="print-route"
                            disabled.bind="!route.driverListUrl"
                            click.trigger="onShowDriverListClick()"
                            translate>
                            Print route
                        </item>

                        <template if-claims="edit-routes">

                            <item
                                if.bind="route.driver"
                                model="reload-route-in-app"
                                click.trigger="onReloadRouteInAppClick()"
                                translate>
                                Reload route in app
                            </item>

                            <item
                                if.bind="!route.driver"
                                model="push-to-drivers"
                                click.trigger="onPushToDriversClick()"
                                translate>
                                Push to drivers
                            </item>

                            <item
                                if.bind="environment == 'development' || route.isPrimaryFulfiller"
                                model="add-support-note"
                                click.trigger="onAddSupportNoteClick()"
                                translate>
                                Add support note
                            </item>

                            <item
                                if.bind="route.driver"
                                model="remove-driver"
                                click.trigger="onRemoveDriverClick()"
                                translate>
                                Remove driver
                            </item>

                            <item
                                if.bind="route"
                                model="add-order"
                                click.trigger="onAddOrdersClick()"
                                translate>
                                Add orders
                            </item>

                        </template>

                    </select-button>

                </toolbar>

            </page-header>

            <route-overview route.bind="route"></route-overview>

            <page-section>

                <div slot="header" class="flex-row">

                    <div translate>
                        Route stops
                    </div>

                    <toolbar class="font-base">

                        <switch-toggle label="before" value.bind="showMap">

                            <div slot="heading" translate>
                                Show map
                            </div>

                        </switch-toggle>

                    </toolbar>

                </div>

                <route-map if="condition.bind: showMap; cache: false" route.bind="route" on-stop-dbl-click.call="onMapStopDblClick(stop)" class="margin-bottom"></route-map>

                <data-table
                    appearance="rows"
                    move.call="onMoveStop(source, target)"
                    class="${!showMap ? '--reduce-header-whitespace' : ''}"
                    element.ref="dataTableElement"
                    insert-mode.bind="route != null && canEditRoute ? 'append' : 'none'"
                    insert.call="onAddStopClick()">

                    <data-table-headers>

                        <data-table-cell>
                            <span class="text-truncate" translate>
                                Stop
                            </span>
                        </data-table-cell>

                        <data-table-cell>
                            <span class="text-truncate" translate>
                                Address
                            </span>
                        </data-table-cell>

                        <data-table-cell>
                            <span class="text-truncate" translate>
                                Reference
                            </span>
                        </data-table-cell>

                        <data-table-cell>
                            <span class="text-truncate" translate>
                                Type
                            </span>
                        </data-table-cell>

                        <data-table-cell align="right">
                            <span class="text-truncate" translate>
                                Colli
                            </span>
                        </data-table-cell>

                        <data-table-cell>
                            <span class="text-truncate" translate>
                                Arrival time
                            </span>
                        </data-table-cell>

                        <data-table-cell>
                            <span class="text-truncate" translate>
                                Time frame
                            </span>
                        </data-table-cell>

                        <data-table-cell align="right">
                            <span class="text-truncate" translate>
                                Task time
                            </span>
                        </data-table-cell>

                        <data-table-cell align="right">
                            <!-- Icons -->
                        </data-table-cell>

                    </data-table-headers>

                    <template repeat.for="i of route.stops.length">

                        <!--
                        HACK:
                        This prevents the page from scrolling to the top every time the page polls and the list is rerendered.
                        Note that this assumes the list is treated as immutable, as it only updates when the list is replaced.
                        -->
                        <let stop.bind="bindingUpdateTrigger && route.stops[i]"></let>

                        <data-table-row
                            model.bind="stop"
                            click.call="onStopClick(stop, false)"
                            clickable.bind="!stop.hidden"
                            insert.call="onAddStopClick($index)"
                            insert-mode.bind="canEditRoute ? 'above' : 'none'"
                            movable.bind="!stop.hidden"
                            class="
                                ${stop.hidden || stop.status.slug == 'cancelled' ? '--cancelled' : stop.status.accent == 'negative' ? '--failed' : ''}
                                ${stop.hidden || route.stops[$index + 1].status.slug == 'cancelled' ? '--next-is-cancelled' : ''}">

                            <let
                                before-accent.bind="!stop.hidden && (stop.status.slug == 'arrived' || stop.status.slug == 'completed' || stop.status.slug == 'failed') ? 'positive' : 'neutral'"
                                after-accent.bind="!stop.hidden && (stop.status.slug == 'completed' || stop.status.slug == 'failed') ? 'positive' : 'neutral'">
                            </let>

                            <data-table-cell class="route-details-stop-number-cell">
                                <div if.bind="!$first" class="route-details-stop-number-before accent-${beforeAccent}"></div>
                                <div if.bind="!$last" class="route-details-stop-number-after accent-${afterAccent}"></div>
                                <div class="route-details-stop-number-marker-background"></div>
                                <div class="route-details-stop-number-marker accent-${stop.status.accent} ${stop.status.slug == 'arrived' ? '--arrived' : ''}">
                                    ${stop.stopNumber}
                                    <icon if.bind="stop.hasAlert" name="ico-warning" accent="negative"></icon>
                                    <icon if.bind="!stop.hasAlert && stop.hasWarning" name="ico-warning" accent="attention"></icon>
                                </div>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${stop.location.address}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${stop.reference}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${stop.type.name}
                                </span>

                            </data-table-cell>

                            <data-table-cell align="right">
                                <span class="text-truncate" accent.bind="stop.hasColliProblem ? 'negative' : undefined & attr" empty-value>
                                    ${stop.scannedColliCount | number}/${stop.totalColliCount | number}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" accent.bind="stop.isDelayed ? 'negative' : undefined & attr" empty-value>
                                    ${stop.arrivedTime || stop.estimates.arrivalTime | time: 'narrow' : false}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${stop.arrivalTimeFrame | timeRange : false}
                                </span>
                            </data-table-cell>

                            <data-table-cell align="right">
                                <span class="text-truncate" if.bind="model.routeStop.type.slug !== 'break'" empty-value>
                                    ${stop.taskTime || stop.estimates.taskTime | duration: 'narrow'}
                                </span>
                                <span class="text-truncate" if.bind="model.routeStop.type.slug === 'break'" empty-value>
                                    ${stop.initialEstimates.taskTime | duration: 'narrow'}
                                </span>
                            </data-table-cell>

                            <data-table-cell align="right">

                                <div if.bind="!stop.hidden" if-claims="edit-routes" class="icon-row">

                                    <button
                                        title.translate="Edit stop"
                                        appearance="none"
                                        accent="primary"
                                        click.trigger="onStopClick(stop, true)">

                                        <icon name="ico-edit-small"></icon>

                                    </button>

                                    <button
                                        title.translate="Cancel stop"
                                        class="icon-row"
                                        appearance="none"
                                        accent="primary"
                                        click.trigger="onRemoveStopClick(stop)">

                                        <icon name="ico-delete-small"></icon>

                                    </button>

                                </div>

                            </data-table-cell>

                        </data-table-row>

                    </template>

                    <template replace-part="insert" translate>
                        Add stop
                    </template>

                </data-table>

                <empty-indicator if.bind="route.stops.length == 0" class="margin-largest">
                    <div slot="heading" translate>No stops</div>
                </empty-indicator>

                <busy-indicator if.bind="route == null" class="margin-largest"></busy-indicator>

            </page-section>

        </page-content>

    </page>

</template>
