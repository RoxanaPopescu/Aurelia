<template>

    <require from="app/components/star-icon/star-icon"></require>
    <require from="app/components/identity-picture/identity-picture"></require>
    <require from="./details.scss"></require>

    <page name="details">

        <page-content scroll scroll.ref="scroll">

            <page-header class="flex-row" scroll-fade>

                <h1 class="font-largest">
                    <path-nav>

                        <a accent="inherit" page-href="path: /distribution-centers" translate>
                            Distribution centers
                        </a>

                        <span>
                            ${distributionCenter.name}
                            <star-icon entity.bind="distributionCenter"></star-icon>
                        </span>

                    </path-nav>
                </h1>

            </page-header>

            <page-section>

                <div slot="header" class="margin-bottom" translate>
                    Route activity
                </div>

                <toolbar scroll-fade="0.2">

                    <search-input value.bind="textFilter & debounce: 200">

                        <span slot="before" class="opacity-faded font-larger line-height-1">
                            <icon name="md-search"></icon>
                        </span>

                        <span slot="placeholder" translate>
                            Filterâ€¦
                        </span>

                    </search-input>

                    <date-input value.bind="dateFilter" zone="utc"></date-input>

                </toolbar>

            </page-section>

            <page-section>

                <data-table
                    appearance="rows"
                    sorting.bind="sorting"
                    busy.bind="busy">

                    <data-table-headers>

                        <data-table-cell name="slug">
                            <span class="text-truncate" translate>
                                Route
                            </span>
                        </data-table-cell>

                        <data-table-cell name="reference">
                            <span class="text-truncate" translate>
                                Reference
                            </span>
                        </data-table-cell>

                        <data-table-cell name="driver.name">
                            <span class="text-truncate" translate>
                                Driver
                            </span>
                        </data-table-cell>

                        <data-table-cell name="gate">
                            <span class="text-truncate" translate>
                                Port
                            </span>
                        </data-table-cell>

                        <data-table-cell name="fulfillerName">
                            <span class="text-truncate" translate>
                                Fulfiller
                            </span>
                        </data-table-cell>

                        <data-table-cell name="plannedArrival">
                            <span translate>
                                Planned arrival
                            </span>
                        </data-table-cell>

                        <data-table-cell name="actualArrival">
                            <span translate>
                                Actual arrival
                            </span>
                        </data-table-cell>

                        <data-table-cell name="plannedDeparture">
                            <span translate>
                                Planned departure
                            </span>
                        </data-table-cell>

                        <data-table-cell name="actualDeparture">
                            <span translate>
                                Actual departure
                            </span>
                        </data-table-cell>

                        <data-table-cell name="colliScanned">
                            <span class="text-truncate" translate>
                                Colli
                            </span>
                        </data-table-cell>

                        <data-table-cell name="driverListReady">
                            <span class="text-truncate" translate>
                                Driver list
                            </span></data-table-cell>

                        <data-table-cell name="route.remarks.length">
                            <span class="text-truncate" translate>
                                Problems
                            </span></data-table-cell>

                    </data-table-headers>

                    <template repeat.for="i of orderedAndFilteredRoutes.length">

                        <!--
                        HACK:
                        This prevents the page from scrolling to the top every time the page polls and the list is rerendered.
                        Note that this assumes the list is treated as immutable, as it only updates when the list is replaced.
                        -->
                        <let route.bind="orderedAndFilteredRoutes[i]"></let>

                        <data-table-row accent.bind="route.hasDelayedArrival || route.hasDelayedDeparture || route.hasRemarks ? 'negative' : 'neutral'">

                            <data-table-cell>
                                <a page-href="path.bind: '/routes/details/' + route.slug" class="text-truncate" target="_blank" empty-value>
                                    ${route.slug}
                                </a>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${route.reference}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${route.driver.name}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${route.gate}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${route.fulfillerName}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${route.plannedArrival | time: undefined : false}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" accent.bind="route.hasDelayedArrival ? 'negative' : 'neutral' & attr" empty-value>
                                    ${route.actualArrival | time: undefined : false}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${route.plannedDeparture | time: undefined : false}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" accent.bind="route.hasDelayedDeparture ? 'negative' : 'neutral' & attr" empty-value>
                                    ${route.actualDeparture | time: undefined : false}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span class="text-truncate" empty-value>
                                    ${route.colliScanned | number} / ${route.colliTotal | number}
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <span empty-value>
                                    <a if.bind="route.driverListUrl != null" href.bind="route.driverListUrl" class="text-truncate" target="_blank">
                                        <template if.bind="route.driverListReady" translate>
                                            Ready
                                        </template>
                                        <template if.bind="!route.driverListReady" translate>
                                            Draft
                                        </template>
                                    </a>
                                </span>
                            </data-table-cell>

                            <data-table-cell>
                                <a class="text-truncate" click.trigger="onReportProblemClick(route)">
                                    <span if.bind="route.remarks.length > 0" accent="negative" translate>
                                        ${route.remarks.length | number} ${route.remarks.length | plural: "problem" : "problems"}
                                    </span>
                                    <tempalte else translate>
                                        Report problem
                                    </tempalte>
                                </a>
                            </data-table-cell>

                        </data-table-row>

                    </template>

                </data-table>

                <busy-indicator if.bind="orderedAndFilteredRoutes == null" class="margin-largest"></busy-indicator>

                <empty-indicator if.bind="orderedAndFilteredRoutes.length == 0" class="margin-largest">
                    <div slot="heading" translate>
                        No results
                    </div>
                </empty-indicator>

            </page-section>

        </page-content>

    </page>

</template>
