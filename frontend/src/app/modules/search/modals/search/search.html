<template>

    <require from="./components/search-item/search-item"></require>
    <require from="./components/search-result/search-result"></require>
    <require from="app/components/info-card/info-card"></require>
    <require from="./search.scss"></require>

    <modal-backdrop close="all"></modal-backdrop>

    <modal-panel name="search" close-button.bind="true" close-shortcut.bind="true" scroll>

        <div slot="actions">

            <button
                show.bind="queryText"
                disabled.bind="!canSave"
                appearance="icon"
                title.translate="Save search"
                click.trigger="saveClick()"
                class="au-animate animation-fade-in-short animation-fade-out-short">
                <icon name="md-save"></icon>
            </button>

        </div>

        <modal-header scroll-fade>

            <h1 class="font-largest margin-bottom" translate>
                Search
            </h1>

            <search-input value.bind="queryText & debounce: 300" autofocus ref="queryInputElement">

                <span slot="before">
                    <icon name="md-search" class="font-larger opacity-faded"></icon>
                </span>

                <span slot="placeholder" translate>
                    Type to searchâ€¦
                </span>

            </search-input>

        </modal-header>

        <modal-section
            if.bind="!queryText || filteredSavedSearches.length > 0"
            class="margin-bottom"
            toggle.bind="true"
            expanded.from-view="savedSectionExpanded">

            <div slot="header" translate>
                Saved searches
            </div>

            <list-layout if.bind="savedSearches == null">

                <search-item repeat.for="i of 3"></search-item>

            </list-layout>

            <div if.bind="savedSearches != null">

                <info-card
                    if.bind="savedSearches.length == 0"
                    heading.translate="You have no saved searches"
                    translate>
                    To save a search, type a query and click <icon inline name="md-save" accent="primary"></icon>
                </info-card>

                <div if.bind="savedSearches.length > 0 && filteredSavedSearches.length == 0" class="opacity-faded" translate>
                    No searches match your filter
                </div>

                <list-layout>

                    <search-item
                        repeat.for="search of filteredSavedSearches | take: showMoreSavedSearches ? undefined : savedSearchesLimit"
                        model.bind="search"
                        click.trigger="searchClick($event, search, true)"
                        delete-click.call="deleteClick(search)">
                    </search-item>

                </list-layout>

                <div if.bind="filteredSavedSearches.length > savedSearchesLimit" class="margin-top">

                    <a if.bind="!showMoreSavedSearches" click.trigger="showMoreSavedSearches = true" translate>
                        Show all
                    </a>

                    <a if.bind="showMoreSavedSearches" click.trigger="showMoreSavedSearches = false" translate>
                        Show less
                    </a>

                </div>

            </div>

        </modal-section>

        <modal-section
            if.bind="!queryText || filteredRecentSearches.length > 0"
            class="${queryText ? 'margin-bottom' : ''}"
            toggle.bind="true"
            expanded.from-view="recentSectionExpanded">

            <div slot="header" translate>
                Recent searches
            </div>

            <list-layout if.bind="recentSearches == null">

                <search-item repeat.for="i of 3"></search-item>

            </list-layout>

            <div if.bind="recentSearches != null">

                <info-card
                    if.bind="recentSearches.length == 0"
                    heading.translate="You have no recent searches"
                    translate>
                    Any searches you do will automatically appear here, so they are easy to repeat
                </info-card>

                <div if.bind="recentSearches.length > 0 && filteredRecentSearches.length == 0" class="opacity-faded" translate>
                    No searches match your filter
                </div>

                <list-layout>

                    <search-item
                        repeat.for="search of filteredRecentSearches | take: showMoreRecentSearches ? undefined : recentSearchesLimit"
                        model.bind="search"
                        click.trigger="searchClick($event, search, false)">
                    </search-item>

                </list-layout>

                <div if.bind="filteredRecentSearches.length > recentSearchesLimit" class="margin-top">

                    <a if.bind="!showMoreRecentSearches" click.trigger="showMoreRecentSearches = true" translate>
                        Show more
                    </a>

                    <a if.bind="showMoreRecentSearches" click.trigger="showMoreRecentSearches = false" translate>
                        Show less
                    </a>

                </div>

            </div>

        </modal-section>

        <modal-section
            if.bind="queryText"
            toggle.bind="true"
            expanded.from-view="resultsSectionExpanded"
            class="flex-grow">

            <div slot="header" translate>
                Search results
            </div>

            <list-layout if.bind="searchResults == null">

                <search-result repeat.for="i of 3"></search-item>

            </list-layout>

            <busy-overlay if.bind="operation.pending || operation.error"></busy-overlay>

            <div if.bind="searchResults != null" class="search-results">

                <list-layout>
                    <div if.bind="searchResults.length == 0" class="search-results-empty" translate>
                        No items match your query
                    </div>
                </list-layout>

                <list-layout>

                    <search-result
                        repeat.for="result of searchResults"
                        model.bind="result"
                        click.trigger="resultClick($event)"
                        star-click.call="starClick(result)">
                    </search-result>

                </list-layout>

            </div>

        </modal-section>

    </modal-panel>

</template>
