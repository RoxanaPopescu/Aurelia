<template>

    <require from="app/components/name-value-pair/name-value-pair"></require>
    <require from="app/components/name-value-list/name-value-list"></require>
    <require from="app/components/star-icon/star-icon"></require>
    <require from="app/components/status-message/status-message"></require>

    <require from="./automatic-dispatch-settings-details.scss"></require>

    <page name="automatic-dispatch-settings-details">

        <page-content class="${tab === 'geographic-areas' ? 'page-content-stretch' : ''}" scroll scroll.ref="scroll" validation validation.ref="validation">

            <page-header scroll-fade class="flex-row">

                <h1 class="font-largest">
                    <path-nav>

                        <a accent="inherit" href="/dispatch" translate>
                            Dispatch
                        </a>

                        <a accent="inherit" href="/dispatch/rule-sets" translate>
                            Rule sets
                        </a>

                        <span>
                            ${ruleSetName}
                            <star-icon if.bind="!isNew" entity.bind="settings"></star-icon>
                        </span>

                    </path-nav>
                </h1>

                <toolbar class="flex-push-right">

                    <template if-claims="edit-routes">

                        <div>

                            <button if.bind="!isNew" appearance="outline" accent="primary" click.trigger="onRunNowClick()" translate>
                                Run now
                            </button>

                        </div>

                        <div>

                            <button if.bind="!isNew && !settings.paused" appearance="outline" accent="primary" click.trigger="onPauseClick()" translate>
                                Pause
                            </button>

                            <button if.bind="!isNew && settings.paused" appearance="outline" accent="primary" click.trigger="onUnpauseClick()" translate>
                                Unpause
                            </button>

                        </div>

                        <div>

                            <button if.bind="isNew" appearance="solid" accent="primary" click.trigger="onSaveClick()" translate>
                                Create
                            </button>

                            <button if.bind="!isNew" appearance="solid" accent="primary" click.trigger="onSaveClick()" translate>
                                Save changes
                            </button>

                        </div>

                    </template>

                </toolbar>

            </page-header>

            <status-message if.bind="settings.paused">
                <span translate>
                    This rule set is currently paused.
                </span>
            </status-message>

            <page-section if-claims="edit-routes">

                <div class="control-row margin-large-bottom">

                    <text-input label="above" value.bind="settings.name" class="flex-basis-1-of-4" autofocus>

                        <div slot="heading" translate>
                            Rule set name
                        </div>

                        <div slot="validation">

                            <required-validator
                                value.bind="settings.name">
                            </required-validator>

                        </div>

                    </text-input>

                </div>

                <div class="control-row">

                    <check-toggle
                        label="after"
                        value.bind="settings.autoApprove">

                        <div slot="heading" translate>
                            Automatically approve dispatch jobs
                        </div>

                    </check-toggle>

                </div>

            </page-section>

            <hr class="hr-line margin-larger" if-claims="edit-routes">

            <page-section class="margin-top">

                <div class="flex-row">

                    <div class="flex-basis-1-of-2 margin-large-right">

                        <h2 class="font-larger margin-bottom" translate>
                            Order filter
                        </h2>

                        <p class="opacity-faded margin-large-bottom" translate>
                            This filter selects the orders that should be automatically dispatched.
                        </p>

                        <tags-input
                            value.bind="settings.shipmentFilter.organizations"
                            label="above"
                            filter="auto"
                            fixed.bind="true"
                            class="margin-large-bottom">

                            <div slot="heading" translate>
                                For orders from one of these creators…
                            </div>

                            <span slot="placeholder" translate>
                                Choose creators
                            </span>

                            <div slot="value">
                                <tag repeat.for="organization of settings.shipmentFilter.organizations">
                                    ${organization.primaryName}
                                </tag>
                            </div>

                            <item repeat.for="organization of availableCreators" model.bind="organization">
                                ${organization.primaryName}
                            </item>

                            <div slot="validation">

                                <dependent-validator
                                    set-validity.one-time="true"
                                    validators.bind="shipmentDependentValidator">
                                </dependent-validator>

                            </div>

                        </tags-input>

                        <tags-input
                            value.bind="settings.shipmentFilter.vehicleTypes"
                            new.bind="true"
                            label="above"
                            fixed.bind="true"
                            class="margin-large-bottom">

                            <div slot="heading" translate>
                                Match if the order has one of these vehicle types…
                            </div>

                            <span slot="placeholder" translate>
                                Choose vehicle type
                            </span>

                            <div slot="value">
                                <tag model.bind="vehicleType" repeat.for="vehicleType of settings.shipmentFilter.vehicleTypes">
                                    ${vehicleType.name}
                                </tag>
                            </div>

                            <item repeat.for="vehicleType of availableVehicleTypes" model.bind="vehicleType">
                                ${vehicleType.name}
                            </item>

                            <div slot="validation">

                                <dependent-validator
                                    set-validity.one-time="true"
                                    validators.bind="shipmentDependentValidator">
                                </dependent-validator>

                            </div>

                        </tags-input>

                        <div class="font-small ${shipmentDependentValidator.invalid ? 'margin-large-bottom' : ''}">

                            <custom-validator
                                view-model.ref="shipmentDependentValidator"
                                valid.bind="settings.shipmentFilter.organizations.length > 0 || settings.shipmentFilter.vehicleTypes.length > 0">

                                <template replace-part="invalid" translate>
                                    Please choose at least one creator or vehicle type.
                                </template>

                            </custom-validator>

                        </div>

                        <duration-input
                            label="above"
                            value.bind="settings.shipmentFilter.pickupLeadTime"
                            min.bind="0"
                            class="margin-large-bottom">

                            <div slot="heading" translate>
                                And pickup should occur within the next…
                            </div>

                            <span slot="after" class="opacity-faded" translate>
                                min
                            </span>

                            <div slot="validation">

                                <required-validator
                                    value.bind="settings.shipmentFilter.pickupLeadTime">
                                </required-validator>

                                <range-validator
                                    active.bind="true"
                                    value.bind="settings.shipmentFilter.pickupLeadTime"
                                    min.bind="0">
                                </range-validator>

                            </div>

                        </duration-input>

                    </div>

                    <div class="flex-basis-1-of-2 margin-large-left">

                        <h2 class="font-larger margin-bottom" translate>
                            Route filter
                        </h2>

                        <p class="opacity-faded margin-large-bottom" translate>
                            This filter selects the routes into which orders may be automatically dispatched.
                        </p>

                        <tags-input
                            value.bind="settings.routeFilter.organizations"
                            label="above"
                            filter="auto"
                            fixed.bind="true"
                            class="margin-large-bottom">

                            <div slot="heading" translate>
                                For routes assigned to one of these contractors…
                            </div>

                            <span slot="placeholder" translate>
                                Choose contractors
                            </span>

                            <div slot="value">
                                <tag repeat.for="organization of settings.routeFilter.organizations">
                                    ${organization.primaryName}
                                </tag>
                            </div>

                            <item repeat.for="organization of availableContractors" model.bind="organization">
                                ${organization.primaryName}
                            </item>

                            <div slot="validation">

                                <dependent-validator
                                    set-validity.one-time="true"
                                    validators.bind="routeDependentValidator">
                                </dependent-validator>

                            </div>

                        </tags-input>

                        <tags-input
                            value.bind="settings.routeFilter.tags"
                            new.bind="true"
                            label="above"
                            fixed.bind="true"
                            class="margin-large-bottom">

                            <div slot="heading" translate>
                                Match if the route has all the tags…
                            </div>

                            <span slot="placeholder" translate>
                                Choose tags
                            </span>

                            <div slot="value">
                                <tag model.bind="tag" repeat.for="tag of settings.routeFilter.tags">
                                    ${tag}
                                </tag>
                            </div>

                            <div slot="validation">

                                <dependent-validator
                                    set-validity.one-time="true"
                                    validators.bind="routeDependentValidator">
                                </dependent-validator>

                            </div>

                        </tags-input>

                        <div class="font-small ${routeDependentValidator.invalid ? 'margin-large-bottom' : ''}">

                            <custom-validator
                                view-model.ref="routeDependentValidator"
                                valid.bind="settings.routeFilter.organizations.length > 0 || settings.routeFilter.tags.length > 0">

                                <template replace-part="invalid" translate>
                                    Please choose at least one contractor or tag.
                                </template>

                            </custom-validator>

                        </div>

                        <duration-input
                            label="above"
                            value.bind="settings.routeFilter.startLeadTime"
                            min.bind="0"
                            class="margin-large-bottom">

                            <div slot="heading" translate>
                                And is started, or starts within the next...
                            </div>

                            <span slot="after" class="opacity-faded" translate>
                                min
                            </span>

                            <div slot="validation">

                                <required-validator
                                    value.bind="settings.routeFilter.startLeadTime">
                                </required-validator>

                            </div>

                        </duration-input>

                    </div>

                </div>

            </page-section>

        </page-content>

    </page>

</template>
