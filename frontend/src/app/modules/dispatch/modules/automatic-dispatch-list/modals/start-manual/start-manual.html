<template>

    <require from="./start-manual.scss"></require>

    <modal-backdrop close="all"></modal-backdrop>

    <modal-panel name="start-manual" position="right" close-button.bind="true" close-shortcut.bind="true" scroll validation validation.ref="validation">

        <modal-header scroll-fade>

            <h1 class="font-largest" tabindex="-1" autofocus="visible.bind: false" translate>
                New dispatch job
            </h1>

        </modal-header>

        <modal-section class="margin-larger-bottom">

            <h2 class="font-larger margin-bottom" translate>
                Order filter
            </h2>

            <div class="opacity-faded margin-large-bottom" translate>
                This filter selects the orders that should be automatically dispatched.
            </div>

            <div class="control-row margin-large-bottom">

                <tags-input
                    label="above"
                    value.bind="model.filters.shipments.organizationIds"
                    class="flex-basis-1-of-1">

                    <div slot="heading" translate>
                        For orders from one of these creators…
                    </div>

                    <div slot="value">
                        <tag repeat.for="id of model.filters.shipments.organizationIds" model.bind="id">
                            ${getOrganizationFromId(id).primaryName}
                        </tag>
                    </div>

                    <item repeat.for="organization of organizations" model.bind="organization.id">
                        ${organization.primaryName}
                    </item>

                    <div slot="validation">

                        <dependent-validator
                            set-validity.one-time="true"
                            validators.bind="shipmentDependentValidator">
                        </dependent-validator>

                    </div>

                </tags-input>

            </div>

            <div class="control-row margin-large-bottom">

                <tags-input
                    label="above"
                    value.bind="model.filters.shipments.vehicleTypes"
                    class="flex-basis-1-of-1">

                    <div slot="heading" translate>
                        Match if the order has one of these vehicle types…
                    </div>

                    <div slot="value">
                        <tag repeat.for="id of model.filters.shipments.vehicleTypes" model.bind="id">
                            ${getVehicleFromId(id).name}
                        </tag>
                    </div>

                    <item repeat.for="vehicleType of vehicleTypes" model.bind="vehicleType.id">
                        ${vehicleType.name}
                    </item>

                    <div slot="validation">

                        <dependent-validator
                            set-validity.one-time="true"
                            validators.bind="shipmentDependentValidator">
                        </dependent-validator>

                    </div>

                </tags-input>

            </div>

            <div class="font-small ${shipmentDependentValidator.invalid ? 'margin-large-bottom' : ''}">

                <custom-validator
                    view-model.ref="shipmentDependentValidator"
                    valid.bind="model.filters.shipments.organizationIds.length > 0 || model.filters.shipments.vehicleTypes.length > 0">

                    <template replace-part="invalid" translate>
                        Please choose at least one creator or vehicle type.
                    </template>

                </custom-validator>

            </div>

            <div class="control-row">

                <duration-input
                    label="above"
                    value.bind="model.filters.shipments.pickupTime"
                    min.bind="0">

                    <div slot="heading" translate>
                        And pickup should occur within the next…
                    </div>

                    <span slot="after" class="opacity-faded" translate>
                        min
                    </span>

                    <div slot="validation">

                        <required-validator
                            value.bind="model.filters.shipments.pickupTime">
                        </required-validator>

                    </div>

                </duration-input>

            </div>

        </modal-section>

        <modal-section class="margin-bottom">

            <h2 class="font-larger margin-bottom" translate>
                Route filter
            </h2>

            <div class="opacity-faded margin-large-bottom" translate>
                This filter selects the routes into which orders may be automatically dispatched.
            </div>

            <div class="control-row margin-large-bottom">

                <tags-input
                    label="above"
                    value.bind="model.filters.routes.organizationIds"
                    class="flex-basis-1-of-1">

                    <div slot="heading" translate>
                        For routes assigned to one of these contractors…
                    </div>

                    <div slot="value">
                        <tag repeat.for="id of model.filters.routes.organizationIds" model.bind="id">
                            ${getOrganizationFromId(id).primaryName}
                        </tag>
                    </div>

                    <item repeat.for="organization of organizations" model.bind="organization.id">
                        ${organization.primaryName}
                    </item>

                    <div slot="validation">

                        <div slot="validation">

                            <dependent-validator
                                set-validity.one-time="true"
                                validators.bind="routeDependentValidator">
                            </dependent-validator>

                        </div>

                    </div>

                </tags-input>

            </div>

            <div class="control-row margin-large-bottom">

                <tags-input
                    label="above"
                    value.bind="model.filters.routes.tags"
                    new.bind="true"
                    class="flex-basis-1-of-1">

                    <div slot="heading" translate>
                        Match if the route has all the tags…
                    </div>

                    <div slot="value">
                        <tag repeat.for="tag of model.filters.routes.tags" model.bind="tag">
                            ${tag}
                        </tag>
                    </div>

                    <div slot="validation">

                        <dependent-validator
                            set-validity.one-time="true"
                            validators.bind="routeDependentValidator">
                        </dependent-validator>

                    </div>

                </tags-input>

            </div>

            <div class="font-small ${routeDependentValidator.invalid ? 'margin-large-bottom' : ''}">

                <custom-validator
                    view-model.ref="routeDependentValidator"
                    valid.bind="model.filters.routes.organizationIds.length > 0 || model.filters.routes.tags.length > 0">

                    <template replace-part="invalid" translate>
                        Please choose at least one contractor or tag.
                    </template>

                </custom-validator>

            </div>

            <div class="control-row">

                <duration-input
                    label="above"
                    none.bind="false"
                    value.bind="model.filters.routes.pickupTime"
                    min.bind="0">

                    <div slot="heading" translate>
                        Pickup time (from now)
                    </div>

                    <span slot="after" class="opacity-faded" translate>
                        min
                    </span>

                    <div slot="validation">

                        <required-validator
                            value.bind="model.filters.routes.pickupTime">
                        </required-validator>

                    </div>

                </duration-input>

        </modal-section>

        <button appearance="solid" accent="primary" click.trigger="onStartClick()" class="margin-large-top" translate>
            Run now
        </button>

    </modal-panel>

</template>
